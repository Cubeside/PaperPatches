From 0e2142248e8796694c77ee357e5c96d0422ce4ff Mon Sep 17 00:00:00 2001
From: Brokkonaut <hannos17@gmx.de>
Date: Sat, 26 Oct 2024 05:42:55 +0200
Subject: [PATCH] Fix "Invalid map dimension: null" and fix loading maps with
 invalid color array

---
 .../level/saveddata/maps/MapItemSavedData.java    | 15 ++++++++++++---
 1 file changed, 12 insertions(+), 3 deletions(-)

diff --git a/src/main/java/net/minecraft/world/level/saveddata/maps/MapItemSavedData.java b/src/main/java/net/minecraft/world/level/saveddata/maps/MapItemSavedData.java
index ae321b3b8..48a20b8ae 100644
--- a/src/main/java/net/minecraft/world/level/saveddata/maps/MapItemSavedData.java
+++ b/src/main/java/net/minecraft/world/level/saveddata/maps/MapItemSavedData.java
@@ -153,10 +153,15 @@ public class MapItemSavedData extends SavedData {
             long least = nbt.getLong("UUIDLeast");
             long most = nbt.getLong("UUIDMost");
 
-            if (least != 0L && most != 0L) {
+            // if (least != 0L && most != 0L) { // Brokko - Fix "Invalid map dimension: null"
                 UUID uniqueId = new UUID(most, least);
 
                 CraftWorld world = (CraftWorld) Bukkit.getWorld(uniqueId);
+                // Brokko start - Fix "Invalid map dimension: null"
+                if (world == null) {
+                    world = (CraftWorld) Bukkit.getWorlds().get(0);
+                }
+                // Brokko end
                 // Check if the stored world details are correct.
                 if (world == null) {
                     /* All Maps which do not have their valid world loaded are set to a dimension which hopefully won't be reached.
@@ -165,7 +170,7 @@ public class MapItemSavedData extends SavedData {
                 } else {
                     return world.getHandle().dimension();
                 }
-            }
+            // } // Brokko - Fix "Invalid map dimension: null"
             throw new IllegalArgumentException("Invalid map dimension: " + String.valueOf(nbt.get("dimension")));
             // CraftBukkit end
         });
@@ -180,8 +185,12 @@ public class MapItemSavedData extends SavedData {
 
         if (abyte.length == 16384) {
             worldmap.colors = abyte;
+            // Brokko start - move up and log
+            worldmap.vanillaRender.buffer = abyte; // Paper
+        } else {
+            MapItemSavedData.LOGGER.warn("Invalid map data size: " + abyte.length);
         }
-        worldmap.vanillaRender.buffer = abyte; // Paper
+        // Brokko end
 
         RegistryOps<Tag> registryops = registries.createSerializationContext(NbtOps.INSTANCE);
         List<MapBanner> list = (List) MapBanner.LIST_CODEC.parse(registryops, nbt.get("banners")).resultOrPartial((s) -> {
-- 
2.32.0.windows.1

