From c6deebb7ac9c1774ace3e04e170d9f45a7ffdf56 Mon Sep 17 00:00:00 2001
From: Brokkonaut <hannos17@gmx.de>
Date: Wed, 11 Jun 2025 06:36:36 +0200
Subject: [PATCH] Save updated player data

---
 .../level/storage/PlayerDataStorage.java      | 19 ++++++++++++++++++-
 1 file changed, 18 insertions(+), 1 deletion(-)

diff --git a/net/minecraft/world/level/storage/PlayerDataStorage.java b/net/minecraft/world/level/storage/PlayerDataStorage.java
index 02f72bf..eab1a56 100644
--- a/net/minecraft/world/level/storage/PlayerDataStorage.java
+++ b/net/minecraft/world/level/storage/PlayerDataStorage.java
@@ -100,7 +100,24 @@ public class PlayerDataStorage {
 
         return optional.or(() -> this.load(nameAndId, ".dat_old")).map(compoundTag -> {
             int dataVersion = NbtUtils.getDataVersion(compoundTag, -1);
-            return ca.spottedleaf.dataconverter.minecraft.MCDataConverter.convertTag(ca.spottedleaf.dataconverter.minecraft.datatypes.MCTypeRegistry.PLAYER, compoundTag, dataVersion, ca.spottedleaf.dataconverter.minecraft.util.Version.getCurrentVersion()); // Paper - rewrite data conversion system
+            compoundTag = ca.spottedleaf.dataconverter.minecraft.MCDataConverter.convertTag(ca.spottedleaf.dataconverter.minecraft.datatypes.MCTypeRegistry.PLAYER, compoundTag, dataVersion, ca.spottedleaf.dataconverter.minecraft.util.Version.getCurrentVersion()); // Paper - rewrite data conversion system
+            // Brokko start - save updated player data
+            if (dataVersion != ca.spottedleaf.dataconverter.minecraft.util.Version.getCurrentVersion()) {
+                LOGGER.info("Saving updated player data for {}", nameAndId.id().toString());
+                NbtUtils.addCurrentDataVersion(compoundTag);
+                try {
+                    Path path = getPlayerDir().toPath();
+                    Path path1 = Files.createTempFile(path, nameAndId.id().toString() + "-", ".dat");
+                    NbtIo.writeCompressed(compoundTag, path1);
+                    Path path2 = path.resolve(nameAndId.id().toString() + ".dat");
+                    Path path3 = path.resolve(nameAndId.id().toString() + ".dat_old");
+                    Util.safeReplaceFile(path2, path1, path3);
+                } catch (Exception ex) {
+                    LOGGER.warn("Failed to save player data for {}", nameAndId.id().toString(), ex);
+                }
+            }
+            // Brokko end
+            return compoundTag; // CraftBukkit - handled above
         });
     }
 
-- 
2.50.1.windows.1

